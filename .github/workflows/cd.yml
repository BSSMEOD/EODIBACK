name: CD - Docker Build & Deploy

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4

    - name: Docker Buildx 설정
      uses: docker/setup-buildx-action@v3

    - name: GitHub Container Registry 로그인
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Docker 메타데이터 추출
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Docker 이미지 빌드 및 푸시
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: 이미지 다이제스트 출력
      run: echo ${{ steps.meta.outputs.digest }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 서버에 SSH 접속 및 Docker Compose 배포
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          # 배포 디렉토리 생성 및 이동
          mkdir -p ~/eod
          cd ~/eod
          
          # GitHub Repository Clone 또는 Pull
          if [ -d ".git" ]; then
            echo "기존 저장소 업데이트 중..."
            git pull origin main
          else
            echo "저장소 복제 중..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # .env 파일 생성 (GitHub Secrets 사용)
          cat > .env << EOF
          GITHUB_REPOSITORY=${{ github.repository }}
          SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}
          SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER=${{ secrets.DB_USERNAME }}
          MYSQL_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF
          
          # GitHub Container Registry 로그인
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Docker Compose로 배포
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d
          
          # 사용하지 않는 이미지 정리
          docker image prune -af
          
    - name: 배포 상태 확인
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          cd ~/eod
          echo "========================================="
          echo "컨테이너 실행 상태:"
          docker compose -f docker-compose.prod.yml ps
          echo "========================================="
          echo "애플리케이션 로그 (최근 20줄):"
          docker compose -f docker-compose.prod.yml logs --tail=20 app
          
    - name: 배포 완료 알림
      if: success()
      run: |
        echo "✅ Docker Compose 배포 완료!"
        echo "서버: ${{ secrets.SSH_HOST }}"
        echo "이미지: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
